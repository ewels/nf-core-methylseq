includeConfig "../modules/bismark_align.config"
includeConfig "../modules/bismark_deduplicate.config"
includeConfig "../modules/samtools_sort.config"
includeConfig "../modules/samtools_index.config"
includeConfig "../modules/bismark_methylationextractor.config"
includeConfig "../modules/bismark_coverage2cytosine.config"
includeConfig "../modules/bismark_report.config"
includeConfig "../modules/bismark_summary.config"

// Override SAMTOOLS_SORT for bismark workflow
// In bismark, deduplication (BISMARK_DEDUPLICATE) happens BEFORE sorting,
// so the BAM input to SAMTOOLS_SORT is already deduplicated when skip_deduplication is false
process {
    withName: SAMTOOLS_SORT {
        ext.prefix = params.skip_deduplication ? { "${meta.id}.sorted" } : { "${meta.id}.deduplicated.sorted" }
        publishDir = [
            [
                path: { "${params.outdir}/${params.aligner}/deduplicated/" },
                mode: params.publish_dir_mode,
                pattern: "*.deduplicated.sorted.bam"
            ],
            [
                path: { "${params.outdir}/${params.aligner}/alignments/" },
                mode: params.publish_dir_mode,
                pattern: "*.sorted.bam",
                enabled: params.skip_deduplication
            ]
        ]
    }
}
